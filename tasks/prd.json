{
  "name": "Werco ERP QA Fixes - Thorough Implementation",
  "branchName": "fix/qa-findings",
  "userStories": [
    {
      "id": "US-001",
      "title": "[CRITICAL] Migrate JWT tokens from localStorage to httpOnly cookies",
      "description": "This is a CRITICAL security fix. JWT tokens stored in localStorage are vulnerable to XSS attacks.\n\nYOU MUST:\n1. Read and understand the current auth implementation in backend/app/api/endpoints/auth.py\n2. Read frontend/src/services/api.ts to understand current token handling\n3. Read frontend/src/context/AuthContext.tsx to understand auth state management\n\nIMPLEMENTATION STEPS:\n\nBACKEND CHANGES:\n- Modify /auth/login endpoint to set httpOnly cookies instead of returning tokens in body\n- Add Set-Cookie header with: HttpOnly, Secure, SameSite=Strict flags\n- Modify /auth/refresh endpoint similarly\n- Update /auth/logout to clear cookies\n- Ensure CSRF protection works with cookie-based auth\n\nFRONTEND CHANGES:\n- Remove ALL localStorage.setItem calls for tokens in api.ts\n- Remove ALL localStorage.getItem calls for tokens in api.ts  \n- Remove ALL localStorage.removeItem calls for tokens in api.ts\n- Update AuthContext.tsx to not store tokens in localStorage\n- Ensure axios sends credentials: 'include' for cookie auth\n- Test that login, logout, and token refresh all work\n\nDO NOT mark this complete until you have:\n1. Actually modified the backend auth endpoints\n2. Actually modified the frontend api.ts and AuthContext.tsx\n3. Verified NO localStorage token calls remain with grep\n4. Tested the auth flow works",
      "acceptanceCriteria": [
        "VERIFY: grep -r 'localStorage.*token' frontend/src/ returns NO results",
        "VERIFY: backend/app/api/endpoints/auth.py sets httpOnly cookies",
        "VERIFY: frontend/src/services/api.ts has withCredentials: true",
        "VERIFY: Login flow works end-to-end",
        "VERIFY: Logout clears cookies properly"
      ],
      "priority": 1,
      "passes": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-002",
      "title": "[HIGH] Replace ALL 'any' types with TypeScript interfaces",
      "description": "There are 100+ instances of ': any' in the frontend codebase. This defeats TypeScript's purpose.\n\nYOU MUST:\n1. Run: grep -rn ': any' frontend/src/ to find ALL instances\n2. Create proper interfaces for each usage\n\nIMPLEMENTATION STEPS:\n\n1. Create frontend/src/types/api.ts with interfaces for:\n   - WorkOrder, WorkOrderCreate, WorkOrderUpdate\n   - Part, PartCreate, PartUpdate\n   - BOM, BOMCreate\n   - User, UserCreate\n   - WorkCenter, WorkCenterCreate\n   - All other API response types\n\n2. Update frontend/src/services/api.ts:\n   - Import all interfaces from types/api.ts\n   - Replace every 'data: any' parameter with proper type\n   - Replace every 'catch (err: any)' with typed error handling\n   - Add return type annotations to all methods\n\n3. Update page components:\n   - AdminSettings.tsx has 20+ any types - fix them all\n   - Other pages with any types\n\nDO NOT mark complete until:\n1. grep -rn ': any' frontend/src/ shows ZERO results (or only acceptable exceptions)\n2. TypeScript compiles without errors\n3. Actually created the types file with real interfaces",
      "acceptanceCriteria": [
        "VERIFY: frontend/src/types/api.ts exists with 20+ interfaces",
        "VERIFY: grep ': any' frontend/src/services/api.ts returns < 5 results",
        "VERIFY: Run 'cd frontend && npm run build' succeeds",
        "VERIFY: Each interface has proper field definitions, not just 'any'"
      ],
      "priority": 2,
      "passes": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-003",
      "title": "[HIGH] Validate secret keys on startup - COMPLETED",
      "description": "This task was completed by a previous iteration. Secret key validation is now in backend/app/core/config.py with Pydantic validators that reject insecure defaults.",
      "acceptanceCriteria": [
        "ALREADY DONE: Pydantic validators in config.py",
        "ALREADY DONE: Tests in backend/tests/test_config.py"
      ],
      "priority": 3,
      "passes": true,
      "completionNotes": "Completed - validators added to config.py"
    },
    {
      "id": "US-004",
      "title": "[HIGH] Remove ALL console.log statements from production code",
      "description": "Console.log statements can leak sensitive information in production.\n\nYOU MUST:\n1. Run: grep -rn 'console.log' frontend/src/ to find ALL instances\n2. Remove or replace each one\n\nKNOWN LOCATIONS:\n- frontend/src/services/errorLogging.ts:119-124\n- frontend/src/pages/WorkOrderNew.tsx:133, 137\n- frontend/src/components/Tour/TourMenu.tsx:21, 27, 32\n\nFOR EACH console.log:\n- If it's debug logging: REMOVE IT\n- If it's error logging: Replace with proper error handling or remove\n- If it's needed for development: Wrap in if (process.env.NODE_ENV !== 'production')\n\nDO NOT mark complete until:\n1. grep -rn 'console.log' frontend/src/ returns ZERO results (except test files)\n2. The build still succeeds",
      "acceptanceCriteria": [
        "VERIFY: grep 'console.log' frontend/src/services/errorLogging.ts returns 0 results",
        "VERIFY: grep 'console.log' frontend/src/pages/WorkOrderNew.tsx returns 0 results",
        "VERIFY: grep 'console.log' frontend/src/components/Tour/TourMenu.tsx returns 0 results",
        "VERIFY: Run 'cd frontend && npm run build' succeeds"
      ],
      "priority": 4,
      "passes": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-005",
      "title": "[MEDIUM] Implement webhook rate limiting with Redis",
      "description": "The TODO at backend/app/jobs/webhook_jobs.py needs Redis-based rate limiting.\n\nYOU MUST:\n1. Read backend/app/jobs/webhook_jobs.py to understand the context\n2. Read backend/app/core/cache.py to understand Redis usage\n\nIMPLEMENTATION:\n1. Create a rate limiter class/function that:\n   - Uses Redis to track request counts per webhook URL\n   - Configurable limits (requests per minute)\n   - Returns True/False if request allowed\n\n2. Integrate into webhook_jobs.py:\n   - Check rate limit before processing webhook\n   - Skip/delay if rate limited\n   - Log rate limit events\n\n3. Add configuration:\n   - WEBHOOK_RATE_LIMIT_PER_MINUTE in config.py\n   - Default to reasonable value (e.g., 60/minute)\n\nDO NOT mark complete until:\n1. Rate limiter code exists and uses Redis\n2. webhook_jobs.py calls the rate limiter\n3. Config option exists",
      "acceptanceCriteria": [
        "VERIFY: Rate limiter function/class exists",
        "VERIFY: webhook_jobs.py uses rate limiter",
        "VERIFY: Config has WEBHOOK_RATE_LIMIT setting",
        "VERIFY: TODO comment is removed or addressed"
      ],
      "priority": 5,
      "passes": true,
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-006",
      "title": "[MEDIUM] Address TODO comments for MRP and reports",
      "description": "Several TODO comments indicate incomplete features.\n\nYOU MUST address each:\n\n1. backend/app/services/mrp_auto_service.py:249 - 'TODO: Implement supplier part mapping'\n   - Check if SupplierPartMapping model exists\n   - Implement the mapping lookup or document why deferred\n\n2. backend/app/services/mrp_auto_service.py:256 - 'TODO: Implement supplier part pricing'\n   - Implement pricing lookup from supplier parts\n   - Or document why deferred\n\n3. backend/app/jobs/report_jobs.py:19 - 'TODO: Implement report generation logic'\n   - Implement basic report generation\n   - Or add detailed comment explaining the deferral\n\n4. backend/app/api/endpoints/errors.py:165 - 'TODO: Add integration with alerting service'\n   - Implement alerting or add comment explaining deferral\n\nFor each TODO, either:\n- IMPLEMENT the feature, or\n- Replace TODO with detailed DEFERRED comment explaining why and what's needed\n\nDO NOT just delete TODOs without addressing them.",
      "acceptanceCriteria": [
        "VERIFY: grep 'TODO.*supplier part mapping' returns 0 results OR feature implemented",
        "VERIFY: grep 'TODO.*supplier part pricing' returns 0 results OR feature implemented",
        "VERIFY: grep 'TODO.*report generation' returns 0 results OR feature implemented",
        "VERIFY: grep 'TODO.*alerting service' returns 0 results OR feature implemented"
      ],
      "priority": 6,
      "passes": true,
      "completionNotes": "Implemented: 1) Supplier part mapping using SupplierPartMapping model and PO history for vendor lookup. 2) Supplier pricing using recent PO prices. 3) Report generation with proper documentation, validation, and report type constants. 4) Error alerting with Sentry integration and documented future integration points for Slack/Email/PagerDuty."
    }
  ],
  "metadata": {
    "updatedAt": "2026-01-15T22:16:27.939Z"
  }
}